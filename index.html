<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–µ–º–µ–π–Ω—ã–µ –ó–∞–¥–∞—á–∏</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            color: #333;
        }
        .container {
            max-width: 100%;
            padding: 20px;
            box-sizing: border-box;
        }
        .task-form {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .task-form input, .task-form button {
            width: 100%;
            padding: 12px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 16px;
        }
        .task-form button {
            background-color: #2481cc;
            color: white;
            border: none;
            font-weight: bold;
            cursor: pointer;
        }
        .task-form button:hover {
            background-color: #1a6fb3;
        }
        .task-list {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .task-item {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
        }
        .task-item:last-child {
            border-bottom: none;
        }
        .task-title {
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 16px;
        }
        .task-datetime {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
        }
        .task-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .edit-btn, .delete-btn {
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            flex: 1;
            min-width: 80px;
        }
        .edit-btn {
            background-color: #ffc107;
            color: #000;
        }
        .delete-btn {
            background-color: #dc3545;
            color: white;
        }
        .edit-btn:hover {
            background-color: #e0a800;
        }
        .delete-btn:hover {
            background-color: #c82333;
        }
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }
        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        .header {
            text-align: center;
            margin-bottom: 20px;
        }
        .header h1 {
            margin: 0;
            color: #2481cc;
            font-size: 24px;
        }
        .header p {
            margin: 5px 0 0 0;
            color: #666;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìù –°–µ–º–µ–π–Ω—ã–µ –ó–∞–¥–∞—á–∏</h1>
            <p>–£–ø—Ä–∞–≤–ª—è–π—Ç–µ –∑–∞–¥–∞—á–∞–º–∏ –∏ –ø–æ–ª—É—á–∞–π—Ç–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è</p>
        </div>

        <div class="task-form">
            <h3>‚ûï –ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞</h3>
            <input type="text" id="taskTitle" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä: –ü–æ—Å–µ—Ç–∏—Ç—å –≤—Ä–∞—á–∞)">
            <input type="datetime-local" id="taskDateTime">
            <button onclick="createTask()">–î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É</button>
        </div>

        <div class="task-list" id="taskList">
            <div class="loading">üîÑ –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–¥–∞—á...</div>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.ready();

        const RAILWAY_URL = 'https://railwaybot-production-e3bc.up.railway.app';
        const USER_ID = tg.initDataUnsafe.user.id;

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∑–∞–¥–∞—á–∏ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ
        loadTasks();

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–π –∑–∞–¥–∞—á–∏
        async function createTask() {
            const title = document.getElementById('taskTitle').value;
            const datetime = document.getElementById('taskDateTime').value;

            if (!title || !datetime) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
                return;
            }

            const task = {
                userId: USER_ID,
                title: title,
                datetime: datetime,
                notified: false
            };

            try {
                const response = await fetch(RAILWAY_URL + '/addtask', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(task)
                });

                if (response.ok) {
                    document.getElementById('taskTitle').value = '';
                    document.getElementById('taskDateTime').value = '';
                    alert('‚úÖ –ó–∞–¥–∞—á–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞! –í—ã –ø–æ–ª—É—á–∏—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∑–∞ 5 —á–∞—Å–æ–≤ –¥–æ –Ω–∞—á–∞–ª–∞.');
                    loadTasks(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
                } else {
                    const errorData = await response.json();
                    alert('‚ùå –û—à–∏–±–∫–∞: ' + (errorData.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                alert('‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞—á
        async function loadTasks() {
            try {
                const response = await fetch(RAILWAY_URL + '/gettasks', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        userId: USER_ID
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    displayTasks(data.tasks);
                } else {
                    showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞—á');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞—á:', error);
                showError('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∑–∞–¥–∞—á
        function displayTasks(tasks) {
            const taskList = document.getElementById('taskList');
            
            if (!tasks || tasks.length === 0) {
                taskList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìù</div>
                        <div>–ó–∞–¥–∞—á –ø–æ–∫–∞ –Ω–µ—Ç</div>
                        <div style="font-size: 12px; margin-top: 5px;">–°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—É—é –∑–∞–¥–∞—á—É!</div>
                    </div>
                `;
                return;
            }

            // –°–æ—Ä—Ç–∏—Ä—É–µ–º –∑–∞–¥–∞—á–∏ –ø–æ –¥–∞—Ç–µ (—Å–Ω–∞—á–∞–ª–∞ –±–ª–∏–∂–∞–π—à–∏–µ)
            tasks.sort((a, b) => new Date(a.datetime) - new Date(b.datetime));

            taskList.innerHTML = tasks.map(task => {
                const date = new Date(task.datetime);
                const now = new Date();
                const isPast = date < now;
                const statusIcon = task.notified ? 'üîî' : (isPast ? '‚úÖ' : '‚è∞');
                const statusText = task.notified ? '–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ' : 
                                 isPast ? '–ó–∞–≤–µ—Ä—à–µ–Ω–æ' : '–û–∂–∏–¥–∞–µ—Ç';
                const pastClass = isPast ? 'style="opacity: 0.6;"' : '';

                return `
                    <div class="task-item" ${pastClass}>
                        <div class="task-title">${task.title} ${statusIcon}</div>
                        <div class="task-datetime">
                            üìÖ ${date.toLocaleString('ru-RU')}
                            <br>${statusText}
                        </div>
                        <div class="task-actions">
                            <button class="edit-btn" onclick="editTask('${task.id}', '${task.title}', '${task.datetime}')">
                                ‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å
                            </button>
                            <button class="delete-btn" onclick="deleteTask('${task.id}', '${task.title}')">
                                üóëÔ∏è –£–¥–∞–ª–∏—Ç—å
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–¥–∞—á–∏
        async function editTask(taskId, currentTitle, currentDatetime) {
            // –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º –∫–∞–≤—ã—á–∫–∏ –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏
            const safeTitle = currentTitle.replace(/"/g, '&quot;');
            
            const newTitle = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏:', safeTitle);
            if (newTitle === null) return;

            // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É –¥–ª—è input[type=datetime-local]
            const date = new Date(currentDatetime);
            const formattedDate = date.toISOString().slice(0, 16);

            const newDatetime = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—É—é –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è:', formattedDate);
            if (newDatetime === null) return;

            try {
                const response = await fetch(RAILWAY_URL + '/updatetask', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        taskId: taskId,
                        userId: USER_ID,
                        title: newTitle,
                        datetime: newDatetime
                    })
                });

                if (response.ok) {
                    alert('‚úÖ –ó–∞–¥–∞—á–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞!');
                    loadTasks();
                } else {
                    const errorData = await response.json();
                    alert('‚ùå –û—à–∏–±–∫–∞: ' + (errorData.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:', error);
                alert('‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–¥–∞—á–∏
        async function deleteTask(taskId, taskTitle) {
            if (!confirm(`‚ùå –í—ã —É–≤–µ—Ä–µ–Ω—ã —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É?\n"${taskTitle}"`)) {
                return;
            }

            try {
                const response = await fetch(RAILWAY_URL + '/deletetask', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        taskId: taskId,
                        userId: USER_ID
                    })
                });

                if (response.ok) {
                    alert('‚úÖ –ó–∞–¥–∞—á–∞ —É–¥–∞–ª–µ–Ω–∞!');
                    loadTasks();
                } else {
                    const errorData = await response.json();
                    alert('‚ùå –û—à–∏–±–∫–∞: ' + (errorData.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è:', error);
                alert('‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ –æ—à–∏–±–∫–∏
        function showError(message) {
            const taskList = document.getElementById('taskList');
            taskList.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">‚ùå</div>
                    <div>${message}</div>
                    <button onclick="loadTasks()" style="margin-top: 10px; padding: 8px 16px; background: #2481cc; color: white; border: none; border-radius: 6px; cursor: pointer;">
                        –ü–æ–≤—Ç–æ—Ä–∏—Ç—å
                    </button>
                </div>
            `;
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞—Ç—É/–≤—Ä–µ–º—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –Ω–∞ –∑–∞–≤—Ç—Ä–∞ –≤ —ç—Ç–æ –∂–µ –≤—Ä–µ–º—è
        window.addEventListener('DOMContentLoaded', () => {
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            tomorrow.setMinutes(0, 0, 0);
            
            const datetimeInput = document.getElementById('taskDateTime');
            datetimeInput.value = tomorrow.toISOString().slice(0, 16);
        });
    </script>
</body>
</html>
