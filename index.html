<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–µ–º–µ–π–Ω—ã–µ –ó–∞–¥–∞—á–∏</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            color: #333;
        }
        .container {
            max-width: 100%;
            padding: 20px;
            box-sizing: border-box;
        }
        .header {
            text-align: center;
            margin-bottom: 20px;
        }
        .header h1 {
            margin: 0;
            color: #2481cc;
            font-size: 24px;
        }
        .header p {
            margin: 5px 0 0 0;
            color: #666;
            font-size: 14px;
        }
        .family-info {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            text-align: center;
        }
        .family-info h3 {
            margin: 0 0 10px 0;
            font-size: 18px;
        }
        .family-info p {
            margin: 5px 0;
            font-size: 14px;
            opacity: 0.9;
        }
        .no-family {
            background: #ff6b6b;
            color: white;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            text-align: center;
        }
        .task-form {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .task-form input, .task-form select, .task-form button {
            width: 100%;
            padding: 12px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 16px;
        }
        .task-form button {
            background-color: #2481cc;
            color: white;
            border: none;
            font-weight: bold;
            cursor: pointer;
        }
        .task-form button:hover {
            background-color: #1a6fb3;
        }
        .task-type-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        .task-type-btn {
            flex: 1;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
        }
        .task-type-btn.active {
            border-color: #2481cc;
            background: #e3f2fd;
            color: #2481cc;
        }
        .task-type-btn.personal.active {
            border-color: #28a745;
            background: #e8f5e8;
            color: #28a745;
        }
        .task-type-btn.family.active {
            border-color: #667eea;
            background: #eef2ff;
            color: #667eea;
        }
        .task-list {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .task-item {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            position: relative;
        }
        .task-item:last-child {
            border-bottom: none;
        }
        .task-item.family-task {
            border-left: 4px solid #667eea;
            background: #f8f9ff;
        }
        .task-item.personal-task {
            border-left: 4px solid #28a745;
        }
        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }
        .task-title {
            font-weight: bold;
            font-size: 16px;
            flex: 1;
            margin-right: 10px;
        }
        .task-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            white-space: nowrap;
        }
        .badge-personal {
            background: #e8f5e8;
            color: #28a745;
        }
        .badge-family {
            background: #eef2ff;
            color: #667eea;
        }
        .task-datetime {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
        }
        .task-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .edit-btn, .delete-btn {
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            flex: 1;
            min-width: 80px;
        }
        .edit-btn {
            background-color: #ffc107;
            color: #000;
        }
        .delete-btn {
            background-color: #dc3545;
            color: white;
        }
        .edit-btn:hover {
            background-color: #e0a800;
        }
        .delete-btn:hover {
            background-color: #c82333;
        }
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }
        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        .tabs {
            display: flex;
            margin-bottom: 20px;
            background: white;
            border-radius: 12px;
            padding: 5px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }
        .tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s;
        }
        .tab.active {
            background: #2481cc;
            color: white;
        }
        .family-section {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .family-section h3 {
            margin-top: 0;
            color: #667eea;
        }
        .create-family-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            width: 100%;
            margin-bottom: 15px;
        }
        .user-id {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 14px;
            margin-bottom: 15px;
            word-break: break-all;
        }
        .invite-section {
            display: flex;
            gap: 10px;
        }
        .invite-input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        .invite-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 6px;
            cursor: pointer;
            white-space: nowrap;
        }
        .members-list {
            margin-top: 15px;
        }
        .member-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid #eee;
        }
        .member-item:last-child {
            border-bottom: none;
        }
        .member-info {
            flex: 1;
        }
        .member-id {
            font-size: 12px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ –°–µ–º–µ–π–Ω—ã–µ –ó–∞–¥–∞—á–∏</h1>
            <p>–£–ø—Ä–∞–≤–ª—è–π—Ç–µ –ª–∏—á–Ω—ã–º–∏ –∏ –æ–±—â–∏–º–∏ –∑–∞–¥–∞—á–∞–º–∏ —Å–µ–º—å–∏</p>
        </div>

        <div id="familySection"></div>

        <div class="tabs">
            <div class="tab active" onclick="switchTab('tasks')">üìã –ó–∞–¥–∞—á–∏</div>
            <div class="tab" onclick="switchTab('family')">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ –°–µ–º—å—è</div>
        </div>

        <div id="tasksTab">
            <div class="task-form">
                <h3>‚ûï –ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞</h3>
                
                <div class="task-type-selector">
                    <div class="task-type-btn personal active" onclick="selectTaskType('personal')">
                        üë§ –õ–∏—á–Ω–∞—è
                    </div>
                    <div class="task-type-btn family" onclick="selectTaskType('family')">
                        üë®‚Äçüë©‚Äçüëß‚Äçüë¶ –°–µ–º–µ–π–Ω–∞—è
                    </div>
                </div>

                <input type="text" id="taskTitle" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä: –°–µ–º–µ–π–Ω—ã–π —É–∂–∏–Ω)">
                <input type="datetime-local" id="taskDateTime">
                <button onclick="createTask()">–î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É</button>
            </div>

            <div class="task-list" id="taskList">
                <div class="loading">üîÑ –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–¥–∞—á...</div>
            </div>
        </div>

        <div id="familyTab" style="display: none;">
            <div class="family-section">
                <h3>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ–º—å–µ–π</h3>
                
                <div id="familyManagement">
                    <div class="loading">üîÑ –ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å–µ–º—å–µ...</div>
                </div>

                <div style="margin-top: 20px;">
                    <h4>üí° –í–∞—à ID –¥–ª—è –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–π:</h4>
                    <div class="user-id" id="userIdDisplay">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                    <p style="font-size: 12px; color: #666; margin-top: 5px;">
                        –ü–æ–¥–µ–ª–∏—Ç–µ—Å—å —ç—Ç–∏–º ID —Å —Ç–µ–º–∏, –∫–æ–≥–æ —Ö–æ—Ç–∏—Ç–µ –ø—Ä–∏–≥–ª–∞—Å–∏—Ç—å –≤ —Å–µ–º—å—é
                    </p>
                </div>

                <div style="margin-top: 20px;">
                    <h4>üì® –ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –≤ —Å–µ–º—å—é</h4>
                    <div class="invite-section">
                        <input type="text" class="invite-input" id="inviteUserId" placeholder="ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
                        <button class="invite-btn" onclick="inviteToFamily()">–ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.ready();

        const RAILWAY_URL = 'https://railwaybot-production-e3bc.up.railway.app';
        const USER_ID = tg.initDataUnsafe.user.id;
        
        let currentTaskType = 'personal';
        let userFamily = null;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', function() {
            loadTasks();
            loadFamilyInfo();
            setupDefaultDateTime();
            document.getElementById('userIdDisplay').textContent = USER_ID;
        });

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.getElementById('tasksTab').style.display = 'none';
            document.getElementById('familyTab').style.display = 'none';
            
            if (tabName === 'tasks') {
                document.querySelector('.tab:nth-child(1)').classList.add('active');
                document.getElementById('tasksTab').style.display = 'block';
            } else {
                document.querySelector('.tab:nth-child(2)').classList.add('active');
                document.getElementById('familyTab').style.display = 'block';
                loadFamilyInfo();
            }
        }

        // –í—ã–±–æ—Ä —Ç–∏–ø–∞ –∑–∞–¥–∞—á–∏
        function selectTaskType(type) {
            currentTaskType = type;
            document.querySelectorAll('.task-type-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.task-type-btn.${type}`).classList.add('active');
            
            // –û–±–Ω–æ–≤–ª—è–µ–º placeholder –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞
            const titleInput = document.getElementById('taskTitle');
            if (type === 'family') {
                titleInput.placeholder = '–ù–∞–∑–≤–∞–Ω–∏–µ —Å–µ–º–µ–π–Ω–æ–π –∑–∞–¥–∞—á–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä: –°–µ–º–µ–π–Ω—ã–π —É–∂–∏–Ω)';
            } else {
                titleInput.placeholder = '–ù–∞–∑–≤–∞–Ω–∏–µ –ª–∏—á–Ω–æ–π –∑–∞–¥–∞—á–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä: –ü–æ—Å–µ—Ç–∏—Ç—å –≤—Ä–∞—á–∞)';
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å–µ–º—å–µ
        async function loadFamilyInfo() {
            try {
                const response = await fetch(RAILWAY_URL + '/getfamily', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        userId: USER_ID
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    userFamily = data.family;
                    updateFamilyUI();
                } else {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å–µ–º—å–µ');
                    updateFamilyUI();
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å–µ–º—å–µ:', error);
                updateFamilyUI();
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI —Å–µ–º—å–∏
        function updateFamilyUI() {
            const familySection = document.getElementById('familySection');
            const familyManagement = document.getElementById('familyManagement');

            if (userFamily) {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–µ–º—å–µ
                familySection.innerHTML = `
                    <div class="family-info">
                        <h3>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ ${userFamily.name}</h3>
                        <p>–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤: ${userFamily.members.length}</p>
                        <p style="font-size: 12px; opacity: 0.7;">ID —Å–µ–º—å–∏: ${userFamily.id}</p>
                    </div>
                `;

                // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É —Å–æ–∑–¥–∞–Ω–∏—è
                const createdDate = new Date(userFamily.createdAt);
                const formattedDate = createdDate.toLocaleDateString('ru-RU') + ' ' + createdDate.toLocaleTimeString('ru-RU', {hour: '2-digit', minute:'2-digit'});

                familyManagement.innerHTML = `
                    <div style="text-align: center;">
                        <p style="color: #28a745; font-weight: bold;">‚úÖ –í—ã –≤ —Å–µ–º—å–µ "${userFamily.name}"</p>
                        <p style="font-size: 14px; color: #666;">
                            –£—á–∞—Å—Ç–Ω–∏–∫–æ–≤: ${userFamily.members.length}<br>
                            –°–æ–∑–¥–∞–Ω–∞: ${formattedDate}
                        </p>
                    </div>
                    
                    <div class="members-list">
                        <h4>üë• –£—á–∞—Å—Ç–Ω–∏–∫–∏ —Å–µ–º—å–∏:</h4>
                        ${userFamily.members.map(memberId => `
                            <div class="member-item">
                                <div class="member-info">
                                    <div>${memberId === USER_ID.toString() ? 'üëë –í—ã' : 'üë§ –£—á–∞—Å—Ç–Ω–∏–∫'}</div>
                                    <div class="member-id">ID: ${memberId}</div>
                                </div>
                                ${memberId === USER_ID.toString() ? '<div style="color: #ffc107; font-size: 12px;">–°–æ–∑–¥–∞—Ç–µ–ª—å</div>' : ''}
                            </div>
                        `).join('')}
                    </div>
                `;
            } else {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ —Å–æ–∑–¥–∞—Ç—å —Å–µ–º—å—é
                familySection.innerHTML = '';
                familyManagement.innerHTML = `
                    <div class="no-family">
                        <p>‚ùå –í—ã –Ω–µ —Å–æ—Å—Ç–æ–∏—Ç–µ –≤ —Å–µ–º—å–µ</p>
                        <p style="font-size: 14px; margin: 10px 0;">–°–æ–∑–¥–∞–π—Ç–µ —Å–µ–º—å—é —á—Ç–æ–±—ã —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–∞–¥ –æ–±—â–∏–º–∏ –∑–∞–¥–∞—á–∞–º–∏ –≤–º–µ—Å—Ç–µ!</p>
                        <button class="create-family-btn" onclick="createFamilyPrompt()">
                            üè† –°–æ–∑–¥–∞—Ç—å —Å–µ–º—å—é
                        </button>
                    </div>
                `;
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–µ–º—å–∏
        async function createFamilyPrompt() {
            const familyName = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–ª—è –≤–∞—à–µ–π —Å–µ–º—å–∏:');
            if (!familyName) return;

            if (familyName.length < 2 || familyName.length > 50) {
                alert('–ù–∞–∑–≤–∞–Ω–∏–µ —Å–µ–º—å–∏ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—Ç 2 –¥–æ 50 —Å–∏–º–≤–æ–ª–æ–≤');
                return;
            }

            try {
                const response = await fetch(RAILWAY_URL + '/createfamily', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        userId: USER_ID,
                        familyName: familyName
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    alert('‚úÖ –°–µ–º—å—è "' + familyName + '" —Å–æ–∑–¥–∞–Ω–∞!\n\n–¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –ø—Ä–∏–≥–ª–∞—à–∞—Ç—å –¥—Ä—É–≥–∏—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤.');
                    loadFamilyInfo();
                    loadTasks(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –∑–∞–¥–∞—á–∏, —Ç.–∫. —Ç–µ–ø–µ—Ä—å –º–æ–∂–µ–º —Å–æ–∑–¥–∞–≤–∞—Ç—å —Å–µ–º–µ–π–Ω—ã–µ
                } else {
                    const errorData = await response.json();
                    alert('‚ùå –û—à–∏–±–∫–∞: ' + (errorData.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–µ–º—å–∏:', error);
                alert('‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
            }
        }

        // –ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –≤ —Å–µ–º—å—é
        async function inviteToFamily() {
            const inviteUserId = document.getElementById('inviteUserId').value.trim();
            if (!inviteUserId) {
                alert('–í–≤–µ–¥–∏—Ç–µ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
                return;
            }

            if (inviteUserId === USER_ID.toString()) {
                alert('–ù–µ–ª—å–∑—è –ø—Ä–∏–≥–ª–∞—Å–∏—Ç—å —Å–∞–º–æ–≥–æ —Å–µ–±—è');
                return;
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ—Å—Ç–æ–∏—Ç –≤ —Å–µ–º—å–µ
            if (!userFamily) {
                alert('‚ùå –í—ã –Ω–µ —Å–æ—Å—Ç–æ–∏—Ç–µ –≤ —Å–µ–º—å–µ! –°–æ–∑–¥–∞–π—Ç–µ —Å–µ–º—å—é —Å–Ω–∞—á–∞–ª–∞.');
                return;
            }

            try {
                const response = await fetch(RAILWAY_URL + '/invitetofamily', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        userId: USER_ID,
                        inviteUserId: inviteUserId
                    })
                });

                if (response.ok) {
                    alert('‚úÖ –ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!\n\n–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∏—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç –±–æ—Ç–∞.');
                    document.getElementById('inviteUserId').value = '';
                    loadFamilyInfo(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
                } else {
                    const errorData = await response.json();
                    alert('‚ùå –û—à–∏–±–∫–∞: ' + (errorData.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è:', error);
                alert('‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
            }
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏
        async function createTask() {
            const title = document.getElementById('taskTitle').value.trim();
            const datetime = document.getElementById('taskDateTime').value;

            if (!title || !datetime) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
                return;
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –º–æ–∂–Ω–æ –ª–∏ —Å–æ–∑–¥–∞—Ç—å —Å–µ–º–µ–π–Ω—É—é –∑–∞–¥–∞—á—É
            if (currentTaskType === 'family' && !userFamily) {
                alert('‚ùå –î–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–µ–º–µ–π–Ω–æ–π –∑–∞–¥–∞—á–∏ –Ω—É–∂–Ω–æ —Å–æ—Å—Ç–æ—è—Ç—å –≤ —Å–µ–º—å–µ!\n\n–ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤–æ –≤–∫–ª–∞–¥–∫—É "–°–µ–º—å—è" —á—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å –∏–ª–∏ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ —Å–µ–º—å–µ.');
                return;
            }

            const task = {
                userId: USER_ID,
                title: title,
                datetime: datetime,
                isFamilyTask: currentTaskType === 'family'
            };

            try {
                const response = await fetch(RAILWAY_URL + '/addtask', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(task)
                });

                if (response.ok) {
                    document.getElementById('taskTitle').value = '';
                    setupDefaultDateTime();
                    
                    const taskType = currentTaskType === 'family' ? '—Å–µ–º–µ–π–Ω–∞—è' : '–ª–∏—á–Ω–∞—è';
                    alert(`‚úÖ ${taskType} –∑–∞–¥–∞—á–∞ "${title}" –¥–æ–±–∞–≤–ª–µ–Ω–∞!\n\n–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –ø—Ä–∏–¥–µ—Ç –∑–∞ 5 —á–∞—Å–æ–≤ –¥–æ –Ω–∞—á–∞–ª–∞.`);
                    loadTasks();
                } else {
                    const errorData = await response.json();
                    alert('‚ùå –û—à–∏–±–∫–∞: ' + (errorData.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                alert('‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–¥–∞—á
        async function loadTasks() {
            try {
                const response = await fetch(RAILWAY_URL + '/gettasks', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        userId: USER_ID
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    userFamily = data.family; // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–µ–º—å–µ
                    updateFamilyUI();
                    displayTasks(data.tasks);
                } else {
                    showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞—á');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞—á:', error);
                showError('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
            }
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–¥–∞—á
        function displayTasks(tasks) {
            const taskList = document.getElementById('taskList');
            
            if (!tasks || tasks.length === 0) {
                taskList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìù</div>
                        <div>–ó–∞–¥–∞—á –ø–æ–∫–∞ –Ω–µ—Ç</div>
                        <div style="font-size: 12px; margin-top: 5px;">–°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—É—é –∑–∞–¥–∞—á—É!</div>
                    </div>
                `;
                return;
            }

            // –°–æ—Ä—Ç–∏—Ä—É–µ–º –∑–∞–¥–∞—á–∏ –ø–æ –¥–∞—Ç–µ (—Å–Ω–∞—á–∞–ª–∞ –±–ª–∏–∂–∞–π—à–∏–µ)
            tasks.sort((a, b) => new Date(a.datetime) - new Date(b.datetime));

            taskList.innerHTML = tasks.map(task => {
                const date = new Date(task.datetime);
                const now = new Date();
                const isPast = date < now;
                const isFamilyTask = task.isFamilyTask;
                const isOwnTask = task.userId == USER_ID;
                
                const statusIcon = task.notified ? 'üîî' : (isPast ? '‚úÖ' : '‚è∞');
                const statusText = task.notified ? '–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ' : 
                                 isPast ? '–ó–∞–≤–µ—Ä—à–µ–Ω–æ' : '–û–∂–∏–¥–∞–µ—Ç';
                
                const taskClass = isFamilyTask ? 'family-task' : 'personal-task';
                const badgeClass = isFamilyTask ? 'badge-family' : 'badge-personal';
                const badgeText = isFamilyTask ? 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶ –°–µ–º–µ–π–Ω–∞—è' : 'üë§ –õ–∏—á–Ω–∞—è';
                const authorText = isFamilyTask && !isOwnTask ? `<div style="font-size: 12px; color: #888; margin-top: 5px;">–î–æ–±–∞–≤–∏–ª: –¥—Ä—É–≥–æ–π —É—á–∞—Å—Ç–Ω–∏–∫</div>` : '';

                const pastStyle = isPast ? 'style="opacity: 0.6;"' : '';

                return `
                    <div class="task-item ${taskClass}" ${pastStyle}>
                        <div class="task-header">
                            <div class="task-title">${task.title} ${statusIcon}</div>
                            <div class="task-badge ${badgeClass}">${badgeText}</div>
                        </div>
                        <div class="task-datetime">
                            üìÖ ${date.toLocaleString('ru-RU')}
                            <br>${statusText}
                            ${authorText}
                        </div>
                        <div class="task-actions">
                            <button class="edit-btn" onclick="editTask('${task.id}', '${task.title.replace(/'/g, "\\'")}', '${task.datetime}', ${isFamilyTask})">
                                ‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å
                            </button>
                            <button class="delete-btn" onclick="deleteTask('${task.id}', '${task.title.replace(/'/g, "\\'")}')">
                                üóëÔ∏è –£–¥–∞–ª–∏—Ç—å
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏
        async function editTask(taskId, currentTitle, currentDatetime, isFamilyTask) {
            const newTitle = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏:', currentTitle);
            if (newTitle === null) return;

            const date = new Date(currentDatetime);
            const formattedDate = date.toISOString().slice(0, 16);

            const newDatetime = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—É—é –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è:', formattedDate);
            if (newDatetime === null) return;

            try {
                const response = await fetch(RAILWAY_URL + '/updatetask', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        taskId: taskId,
                        userId: USER_ID,
                        title: newTitle,
                        datetime: newDatetime
                    })
                });

                if (response.ok) {
                    alert('‚úÖ –ó–∞–¥–∞—á–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞!');
                    loadTasks();
                } else {
                    const errorData = await response.json();
                    alert('‚ùå –û—à–∏–±–∫–∞: ' + (errorData.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:', error);
                alert('‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
            }
        }

        // –£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏
        async function deleteTask(taskId, taskTitle) {
            if (!confirm(`‚ùå –í—ã —É–≤–µ—Ä–µ–Ω—ã —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É?\n"${taskTitle}"`)) {
                return;
            }

            try {
                const response = await fetch(RAILWAY_URL + '/deletetask', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        taskId: taskId,
                        userId: USER_ID
                    })
                });

                if (response.ok) {
                    alert('‚úÖ –ó–∞–¥–∞—á–∞ —É–¥–∞–ª–µ–Ω–∞!');
                    loadTasks();
                } else {
                    const errorData = await response.json();
                    alert('‚ùå –û—à–∏–±–∫–∞: ' + (errorData.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è:', error);
                alert('‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
            }
        }

        // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –¥–∞—Ç—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–∑–∞–≤—Ç—Ä–∞ –≤ —ç—Ç–æ –∂–µ –≤—Ä–µ–º—è)
        function setupDefaultDateTime() {
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            tomorrow.setMinutes(0, 0, 0);
            
            const datetimeInput = document.getElementById('taskDateTime');
            datetimeInput.value = tomorrow.toISOString().slice(0, 16);
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É
        function showError(message) {
            const taskList = document.getElementById('taskList');
            taskList.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">‚ùå</div>
                    <div>${message}</div>
                    <button onclick="loadTasks()" style="margin-top: 10px; padding: 8px 16px; background: #2481cc; color: white; border: none; border-radius: 6px; cursor: pointer;">
                        –ü–æ–≤—Ç–æ—Ä–∏—Ç—å
                    </button>
                </div>
            `;
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å–µ–º—å–µ –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –≤–∫–ª–∞–¥–æ–∫
        function refreshFamilyInfo() {
            loadFamilyInfo();
            loadTasks();
        }
    </script>
</body>
</html>
